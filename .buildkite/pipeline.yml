steps:
  - label: 'stack rebuild'
    env:
      AWS_REGION: us-west-1
      S3_BUCKET: appveyor-ci-cache
      CACHE_S3_MAX_SIZE: 2500MB
      STACK_ROOT: "/build/cardano-prelude.stack"
    command:
      # cache-s3 needs a build directory that is the same across all buildkite agents.
      # so copy the source into /build/cardano-prelude
      - "rm -rf /build/cardano-prelude"
      - "cp -R . /build/cardano-prelude"
      - "cd /build/cardano-prelude"
      - "nix-build scripts/buildkite -o stack-rebuild"
      - "./stack-rebuild"
    agents:
      system: x86_64-linux

  - label: Check Hydra evaluation of release.nix
    command: 'nix-build -A check-hydra lib.nix -o check-hydra.sh && ./check-hydra.sh'
    agents:
      system: x86_64-linux

  - label: Check auto-generated Nix
    command: 'nix-build -A check-nix-tools lib.nix -o check-nix-tools.sh && ./check-nix-tools.sh'
    agents:
      system: x86_64-linux

#  - label: 'brittany'
#    command:
#      - "nix-build scripts/brittany -o check-brittany"
#      - "./check-brittany"
#    agents:
#      system: x86_64-linux
